<!DOCTYPE html>
<html>

<head>
    <title>Test viva</title>
    <script type="text/javascript" src="../../dist/vivagraph.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">
        function main() {
            // creat graph
            var graph = Viva.Graph.graph();
            
            // 2. Add graph node and edge
            var firstNode = graph.addNode(1, 'Kho tổng');
            firstNode.isPinned = true;
            graph.addNode(10, "Kho Hàm Nghi")
            graph.addNode(11, "Kho Nam Đàn")
            graph.addNode(12, "Kho Nghệ An")
            graph.addNode(13, "Kho Lê TT")
            graph.addNode(14, "Kho Vinh")
            graph.addNode(15, "Kho Đà Nẵng")

            graph.addLink(1,12) ;
            graph.addLink(12,1) ;
            graph.addLink(1,11) ;
            graph.addLink(10,11) ;
            graph.addLink(11,10) ;
            graph.addLink(11,12) ;
            graph.addLink(12,14) ;
            graph.addLink(11,13) ;
            graph.addLink(11,15) ;
            
            // customize node
            var graphics = Viva.Graph.View.svgGraphics(),
                nodeSize = 24,
                hightlightRelateNodes = function(nodeId, isOn) {
                    graph.forEachLinkedNode(nodeId, function(node, link) {
                        var linkUI = graphics.getLinkUI(link.id) ;
                        if(linkUI) {
                            linkUI.attr("stroke", isOn ? "red" : "gray");
                        }
                    });
                };

            graphics.node(function(node) {
                var ui  =  Viva.Graph.svg('g'),
                stationName = Viva.Graph.svg('text').attr('y', '-4px').text(node.data),
                img = Viva.Graph.svg('image')     
                    .attr('width', nodeSize)
                    .attr('height', nodeSize)
                    .link('img/ghtk.png');
                ui.append(stationName) ;
                ui.append(img);
                
                $(ui).hover(function(){
                    hightlightRelateNodes(node.id, true);
                }, function() {
                    hightlightRelateNodes(node.id, false) ;
                });
                return ui;
            }).placeNode(function(nodeUI, pos) {
                nodeUI.attr('transform',
                    'translate(' +
                    (pos.x - nodeSize / 2) + ',' + (pos.y - nodeSize / 2) +
                    ')');
            });
            
            // creat Marker direct link
            var createMarker = function(id) {
                    return Viva.Graph.svg('marker')
                               .attr('id', id)
                               .attr('viewBox', "0 0 10 10")
                               .attr('refX', "10")
                               .attr('refY', "5")
                               .attr('markerUnits', "strokeWidth")
                               .attr('markerWidth', "10")
                               .attr('markerHeight', "5")
                               .attr('orient', "auto");
                },

                marker = createMarker('Triangle');

            marker.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');

            var defs = graphics.getSvgRoot().append('defs');
            defs.append(marker);

            var geom = Viva.Graph.geom();

            graphics.link(function(link){
                
                return Viva.Graph.svg('path')
                           .attr('stroke', 'gray')
                           .attr('marker-end', 'url(#Triangle)');
            }).placeLink(function(linkUI, fromPos, toPos) {
                var toNodeSize = nodeSize,
                    fromNodeSize = nodeSize;

                var from = geom.intersectRect(
                        // rectangle:
                                fromPos.x - fromNodeSize / 2, // left
                                fromPos.y - fromNodeSize / 2, // top
                                fromPos.x + fromNodeSize / 2, // right
                                fromPos.y + fromNodeSize / 2, // bottom
                        // segment:
                                fromPos.x, fromPos.y, toPos.x, toPos.y) || fromPos;

                var to = geom.intersectRect(
                        // rectangle:
                                toPos.x - toNodeSize / 2, // left
                                toPos.y - toNodeSize / 2, // top
                                toPos.x + toNodeSize / 2, // right
                                toPos.y + toNodeSize / 2, // bottom
                        // segment:
                                toPos.x, toPos.y, fromPos.x, fromPos.y) || toPos; 
                
                var data = 'M' + from.x + ',' + from.y +
                           'L' + to.x + ',' + to.y;
                linkUI.attr('d', data);
            });

            // Render the graph
            var renderer = Viva.Graph.View.renderer(graph, {
                graphics : graphics
            }) ;
            renderer.run();
        }
    </script>

    <style type="text/css" media="screen">
        html,body,svg { width: 100%; height: 100%; }
    </style>
</head>

<body onload='main()'>

</body>

</html>